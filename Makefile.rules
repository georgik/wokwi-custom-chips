# Common build rules for Wokwi custom chips
# Based on inverter-chip example from wokwi/wokwi-features

WASI_SDK_VERSION := 27.0
WASI_SDK_PATH := /opt/wasi-sdk

# Compiler settings
CC := clang
CFLAGS := --target=wasm32-unknown-wasi \
          -nostartfiles \
          -Wl,--import-memory \
          -Wl,--export-table \
          -Wl,--no-entry \
          -O2 \
          -Wall \
          -Wextra \
          -Werror \
          -I.

# Output directory
DIST_DIR := ../../dist

# Default target
.PHONY: all clean

all: $(DIST_DIR)/$(CHIP_NAME).chip.wasm

# Create dist directory if it doesn't exist
$(DIST_DIR):
	@mkdir -p $(DIST_DIR)

# Compile chip to WASM
$(DIST_DIR)/$(CHIP_NAME).chip.wasm: $(CHIP_SOURCES) chip.json | $(DIST_DIR)
	@echo "Building $(CHIP_NAME)..."
	@$(CC) $(CFLAGS) -o $@ $(CHIP_SOURCES)
	@cp chip.json $(DIST_DIR)/$(CHIP_NAME).chip.json
	@echo "✓ Built $(CHIP_NAME)"

# Clean build artifacts
clean:
	@echo "Cleaning $(CHIP_NAME)..."
	@rm -f $(DIST_DIR)/$(CHIP_NAME).chip.wasm
	@rm -f $(DIST_DIR)/$(CHIP_NAME).chip.json
	@echo "✓ Cleaned $(CHIP_NAME)"
